<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">

<!-- Load d3.js -->
<script src="https://d3js.org/d3.v4.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-tip/0.7.1/d3-tip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.25.6/d3-legend.min.js"></script>
<style>

.d3-tip {
  line-height: 1;
  padding: 12px;
  background: rgba(43,43,43, 0.8);
  color: #fff;
  border-radius: 2px;}
  
div.tooltip {	
    position: absolute;			
    text-align: center;			
    width: 150px;					
    height: 100px;					
    padding: 2px;				
    font: 12px sans-serif;		
    background: white;	
    border: 0px;		
    border-radius: 8px;			
    pointer-events: none;}	

  </style>
</head>
<!-- Create an element where the map will take place -->
<body>
<svg id="my_dataviz" width="1920" height="1080"></svg>
<div class="tooltip" style="opacity: 0;"></div>

<script type = "text/javascript" src = "us-states.json"></script>
<script type = "text/csv" src = "SenateTest.csv"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.1.2/papaparse.min.js"></script>

<script>

var colorScale = d3.scaleThreshold()
  
  .domain([-50, -15,-5,-1,0,1,5,15,50, 100])
  .range(["#02061E","#040B4B","#0C24C3","#475df4","#B6BFFB","#FB9A9F","#F7454E","#E10A15","#92060D","#1D0103"]);


var leg = d3.select("svg");

leg.append("g")
  .attr("class", "legendQuant")
  .attr("transform", "translate(20,20)");

var legend = d3.legendColor()
    .labelFormat(d3.format(".2f"))
    .labels(d3.legendHelpers.thresholdLabels)
    .title("Margin")
    .scale(colorScale)

leg.select(".legendQuant")
  .call(legend);

// The svg
var svg = d3.select("svg"),
  width = +svg.attr("width"),
  height = +svg.attr("height");

// Map and projection
var path = d3.geoPath();
var projection = d3.geoMercator()
  .scale(10000)
  .center([-84.25,34.25])
  .translate([width / 2, height / 2]);

// Data and color scale
var data = d3.map();
  
  var div = d3.select("body").append("div")	
        .attr("class", "tooltip")				
        .style("opacity", 0);
  

// Load external data and boot

  

 d3.csv('SenateTest.csv', function(data) {
    d3.json('us-states.json', function(json) {
      for (var i = 0; i < data.length; i++) {
        var state = data[i].NAME;
        var margin = data[i].Final;
        var rating = data[i].Rating;
        var repwins = data[i].RepWins

      for (var j = 0; j < json.features.length; j++) {
        var jsonState = json.features[j].properties.name;
        if (state == jsonState) {
          json.features[j].properties.margin=margin;
          json.features[j].properties.rating=rating;
          json.features[j].properties.repwins=repwins;
          break;

        }
      }
    }



  // Draw the map
  svg.append("g")
    .selectAll("path")
    .data(json.features)
    .enter()
    .append("path")
      // draw each country
      .attr("d", d3.geoPath()
        .projection(projection)
      )
      
      .on('mouseover', function(d) {		
            div.transition()		
                .duration(200)		
                .style("opacity", .9);		
            div.html(d.properties.name + "<br> Margin: "  + d.properties.margin + "<br> Rating: " + d.properties.rating + "<br> PCT Chance of Republican Victory: " + d.properties.repwins)	
                .style("left", (d3.event.pageX) + "px")		
                .style("top", (d3.event.pageY - 28) + "px");	
            d3.select(this)
                .transition()
                .duration(200)
                .style("stroke-width", "3px")
                .style("stroke", "black")})
      .on('mouseout', function(d) {		
            div.transition()		
                .duration(500)		
                .style("opacity", 0);
            d3.select(this)
                .transition()
                .duration(20)
                .style("stroke", "transparent")})
      // set the color of each country
      .attr("fill", function (d) {
        return colorScale(d.properties.margin);
        
      });
    })});
  

</script>
</body>
</html>
